import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LinearRegression
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import r2_score,mean_squared_error
from math import radians,sin,cos,asin,sqrt

df = pd.read_csv('/content/uber.csv')
df = df.dropna(subset=['fare_amount','pickup_longitude','pickup_latitude','dropoff_longitude','dropoff_latitude','passenger_count'])
df = df[(df['fare_amount']>0) & (df['fare_amount']<500)]
df =df[(df['passenger_count']>0)&(df['passenger_count']<=6)]

def haversine(lon1,lat1,lon2,lat2):
  lon1,lat1,lon2,lat2=map(radians,[lon1,lat1,lon2,lat2])
  dlon=lon2-lon1
  dlat=lat2-lat1
  a= sin(dlat/2)**2+cos(lat1)*cos(lat2)*sin(dlon/2)**2
  c = 2* asin(sqrt(a))
  km = 6371*c
  return km

df['distance_km']=df.apply(lambda x:haversine(
    x['pickup_longitude'],x['pickup_latitude'],x['dropoff_longitude'],x['dropoff_latitude']),axis=1)
df =df[df['distance_km']>0]

## Indetify Outliners
df = df[df['fare_amount'] < df['fare_amount'].quantile(0.99)]  # remove top 1% fares

#check Corelation
print("\nCorrelation with fare:\n", df.corr(numeric_only=True)['fare_amount'])
sns.heatmap(df[['fare_amount', 'distance_km', 'passenger_count']].corr(),
            annot=True, cmap='coolwarm')
plt.title("Correlation Heatmap")
plt.show()

x= df[['distance_km','passenger_count']]
y=df['fare_amount']
X_train,X_test,y_train,y_test=train_test_split(x,y,test_size=0.2,random_state=42)

lr=LinearRegression()
rf=RandomForestRegressor(n_estimators=100,random_state=43)
lr.fit(X_train,y_train)
rf.fit(X_train,y_train)

y_pred_lr=lr.predict(X_test)
y_pred_rf=rf.predict(X_test)

def evaluate(model,y_true,y_pred):
  print(f"R2 Score: {r2_score(y_true,y_pred):.3f}")
  rmse = sqrt(mean_squared_error(y_true, y_pred))
  print(f"RMSE: {rmse:.3f}")


evaluate("Linear Regression", y_test, y_pred_lr)
evaluate("Random Forest", y_test, y_pred_rf)
